{{ _view.assign('title', 'Все объекты на карте') }}
{{ html.script(['https://api-maps.yandex.ru/2.1/?lang=ru_RU', 'Agency.filter-map-site', 'YandexMaps.simplify'], {'block': 'scriptCustom'}) }}
<div class="filter">
    <div class="container">
        <div class="filter-block row">
            <div class="col-xl-9 col-lg-8 col-md-7 col-sm-6">
                <h1 class="filter-title">Все объекты на карте</h1>
            </div>
        </div>
        <div class="filter-content" style="gap: 10px">
            <div class="map-objects" id="map-list"></div>
            {% set filterUrl = {'plugin':'agency','controller':'realty','action':'map'} %}
            {{ croogo_region alias = "twig_realty_filter_block" }}
        </div>
    </div>
</div>
{{ html.scriptStart({'block': 'scriptCustom', 'safe': false}) }}
    let ClusterIs2bMapSite = {
        url: null,
        init: function (YandexMapCenter, url) {
            this.url = url;
            Is2bMap.init('map-list', YandexMapCenter, [], {'isAdmin': false});
            let d = '';
            this.loadObjects(d, true);
            Is2bMap.map.events.add('boundschange', function (e) {
                if (Is2bMap.block.hasClass('is2b-loaded-points')) {
                    return !1;
                }
                d = Is2bMap.dataMapKlaster();
                ClusterIs2bMapSite.loadObjects(d, false);
            });
        },
        setBounds: function () {
            if (Is2bMap.geoObjects != null) {
                if (Is2bMap.geoObjects.length > 0) {
                    console.log('set Bounds');
                    console.log(Is2bMap.clusterer.getBounds());
                    Is2bMap.map.setBounds(Is2bMap.clusterer.getBounds(), {
                        checkZoomRange: true
                    });
                }
            }
        },
        loadObjects: function (d, setBounds) {
            Is2bMap.removeAllPoints();
            $.ajax({url: this.url + (d === '' ? '' : '&' + d), dataType: 'json'}).done(function (data) {
                console.log(data.length);
                Is2bMap.setPoints(data);
                if (setBounds) {
                    ClusterIs2bMapSite.setBounds();
                }
            });
        }
    };
    ymaps.ready(function () {
        ClusterIs2bMapSite.init({{ yaMaps.YandexMapCenter() }}, window.location.protocol + '//' + window.location.hostname + '/agency/realty/map' + (window.location.search || '?'));
    })
{{ html.scriptEnd() }}
